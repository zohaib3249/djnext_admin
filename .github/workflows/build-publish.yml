# Build frontend, build Python package, publish to PyPI.
# Triggers: push to main/master, push tag v*, or workflow_dispatch (with version bump).
# Secrets: PYPI_API_TOKEN for publishing.
# Package dir: . if repo root has setup.py + frontend; else djnext_admin (monorepo).
name: Build and Publish to PyPI

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump (only for workflow_dispatch)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  version:
    name: Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.outputs.version }}
      tag_name: ${{ steps.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set package directory
        id: pkg
        run: |
          if [ -f setup.py ] && [ -d frontend ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          else
            echo "dir=djnext_admin" >> $GITHUB_OUTPUT
          fi

      - name: Get current version
        id: current
        working-directory: ${{ steps.pkg.outputs.dir }}
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            CURRENT_VERSION="${GITHUB_REF#refs/tags/v}"
          else
            CURRENT_VERSION=$(grep -E "^__version__\s*=\s*['\"]" __init__.py | sed -E "s/^__version__\s*=\s*['\"]([^'\"]+)['\"].*/\1/")
            [ -z "$CURRENT_VERSION" ] && CURRENT_VERSION="0.0.1"
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Bump version (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        id: bump
        working-directory: ${{ steps.pkg.outputs.dir }}
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          BUMP="${{ github.event.inputs.version_bump || 'patch' }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          case "$BUMP" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR+1)); PATCH=0 ;;
            patch) PATCH=$((PATCH+1)) ;;
          esac
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Bumped: $CURRENT -> $NEW_VERSION ($BUMP)"
          sed -i.bak "s/^__version__ = .*/__version__ = '$NEW_VERSION'/" __init__.py
          rm -f __init__.py.bak

      - name: Commit and push version (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch' && steps.bump.outputs.new_version != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PKG="${{ steps.pkg.outputs.dir }}"
          cd "$PKG"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add __init__.py
          git diff --staged --quiet && exit 0
          git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }}"
          git tag -a "${{ steps.bump.outputs.tag_name }}" -m "Release ${{ steps.bump.outputs.new_version }}"
          git push origin HEAD
          git push origin "${{ steps.bump.outputs.tag_name }}"

      - name: Set outputs and write version file
        id: outputs
        run: |
          set -e
          V=""
          T=""
          # workflow_dispatch: use bumped version from previous step
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            V="${{ steps.bump.outputs.new_version }}"
            T="${{ steps.bump.outputs.tag_name }}"
          fi
          # push to tag v*: use version from tag
          if [ -z "$V" ] && [ "${{ github.event_name }}" = "push" ]; then
            REF="${{ github.ref }}"
            case "$REF" in refs/tags/v*) V="${GITHUB_REF#refs/tags/v}"; T="${{ github.ref_name }}"; esac
          fi
          # fallback: current version from __init__.py
          if [ -z "$V" ]; then
            V="${{ steps.current.outputs.version }}"
            T=""
          fi
          V=$(echo "$V" | tr -d '\n\r \t')
          [ -z "$V" ] && V="0.0.1"
          echo "version=$V" >> $GITHUB_OUTPUT
          echo "tag_name=$T" >> $GITHUB_OUTPUT
          printf '%s' "$V" > version.txt
          echo "Resolved version: $V"
          test -s version.txt || { echo "ERROR: version.txt is empty"; exit 1; }

      - name: Upload version file
        uses: actions/upload-artifact@v4
        with:
          name: version-file
          path: version.txt
          retention-days: 1

  build-frontend:
    name: Build frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set package directory
        id: pkg
        run: |
          if [ -f setup.py ] && [ -d frontend ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          else
            echo "dir=djnext_admin" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ steps.pkg.outputs.dir }}/frontend/package-lock.json

      - name: Install and build
        working-directory: ${{ steps.pkg.outputs.dir }}/frontend
        run: |
          npm ci
          npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-out
          path: ${{ steps.pkg.outputs.dir }}/frontend/out
          retention-days: 30

  build-python:
    name: Build Python package
    runs-on: ubuntu-latest
    needs: [version, build-frontend]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set package directory
        id: pkg
        run: |
          if [ -f setup.py ] && [ -d frontend ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          else
            echo "dir=djnext_admin" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download version file
        uses: actions/download-artifact@v4
        with:
          name: version-file
          path: .

      - name: Set version in __init__.py
        id: setver
        run: |
          set -e
          PKG="${{ steps.pkg.outputs.dir }}"
          # Read version from artifact (downloaded to workspace root)
          VERSION=$(cat version.txt 2>/dev/null | tr -d '\n\r \t' || true)
          if [ -z "$VERSION" ]; then
            VERSION="${{ needs.version.outputs.version }}"
          fi
          if [ -z "$VERSION" ]; then
            VERSION=$(grep -E "^__version__\s*=\s*['\"]" "$PKG/__init__.py" 2>/dev/null | sed -E "s/^__version__\s*=\s*['\"]([^'\"]+)['\"].*/\1/" | tr -d '\n\r \t' || true)
          fi
          [ -z "$VERSION" ] && VERSION="0.0.1"
          VERSION=$(echo "$VERSION" | tr -d '\n\r \t')
          [ -z "$VERSION" ] && { echo "ERROR: Version is empty"; exit 1; }
          echo "Resolved version: $VERSION"
          sed -i.bak "s/^__version__ = .*/__version__ = '$VERSION'/" "$PKG/__init__.py"
          rm -f "$PKG/__init__.py.bak"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-out
          path: ${{ steps.pkg.outputs.dir }}/frontend/out

      - name: Run post-build (templates + static)
        working-directory: ${{ steps.pkg.outputs.dir }}
        run: python scripts/post-build-to-static.py

      - name: Install build dependencies
        working-directory: ${{ steps.pkg.outputs.dir }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-build.txt

      - name: Build wheel and sdist
        working-directory: ${{ steps.pkg.outputs.dir }}
        run: python -m build

      - name: Prepare dist for upload (always at workspace dist/)
        run: |
          PKG="${{ steps.pkg.outputs.dir }}"
          if [ "$PKG" != "." ] && [ -d "$PKG/dist" ]; then
            cp -r "$PKG/dist" dist
          fi

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 14

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build-python]
    steps:
      - name: Download dist
        uses: actions/download-artifact@v4
        with:
          name: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          verbose: true
